# RAGæ£€ç´¢éªŒè¯ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿçš„æ£€ç´¢éªŒè¯æ¨¡å—å®ç°ã€‚è¯¥æ¨¡å—ä¸“é—¨ç”¨äºéªŒè¯å‘é‡æ•°æ®åº“çš„æ£€ç´¢åŠŸèƒ½ã€æµ‹è¯•é—®ç­”ç³»ç»Ÿçš„å®Œæ•´æ€§ï¼Œå¹¶æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ä»¥å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

## ç³»ç»Ÿæ¶æ„

### 1. åŠŸèƒ½å®šä½

#### æ ¸å¿ƒç›®æ ‡
- **éªŒè¯å‘é‡æ£€ç´¢**: ç¡®ä¿å‘é‡æ•°æ®åº“æ­£ç¡®å“åº”æŸ¥è¯¢
- **æµ‹è¯•é—®ç­”é“¾è·¯**: éªŒè¯RAGç³»ç»Ÿçš„å®Œæ•´å·¥ä½œæµ
- **è°ƒè¯•æ”¯æŒ**: æä¾›è¯¦ç»†çš„æ£€ç´¢å’Œå›ç­”ä¿¡æ¯
- **é—®é¢˜è¯Šæ–­**: å¿«é€Ÿè¯†åˆ«ç³»ç»Ÿæ•…éšœç‚¹

#### è®¾è®¡ç‰¹ç‚¹
- **è½»é‡çº§**: å•ä¸€å‡½æ•°å®ç°å®Œæ•´éªŒè¯
- **ä¿¡æ¯ä¸°å¯Œ**: å¤šå±‚çº§è¾“å‡ºè°ƒè¯•ä¿¡æ¯
- **é”™è¯¯å‹å¥½**: è¯¦ç»†çš„å¼‚å¸¸å¤„ç†å’Œæç¤º
- **å¯å®šåˆ¶**: æ”¯æŒè‡ªå®šä¹‰æµ‹è¯•é—®é¢˜

### 2. æ£€ç´¢éªŒè¯ç³»ç»Ÿ

#### ä¸»å‡½æ•°ï¼š`test_vector_retrieval_and_answer()`

**å‡½æ•°ç­¾å**
```python
def test_vector_retrieval_and_answer(
    db, 
    qa, 
    test_question="What is the capital of France?"
):
    """
    éªŒè¯å‘é‡æ•°æ®åº“æ£€ç´¢åŠŸèƒ½å¹¶æµ‹è¯•å®Œæ•´é—®ç­”é“¾è·¯
    
    Args:
        db: å‘é‡æ•°æ®åº“å®ä¾‹
        qa: é—®ç­”ç³»ç»Ÿé“¾å®ä¾‹
        test_question: æµ‹è¯•é—®é¢˜ï¼ˆå¯é€‰ï¼Œé»˜è®¤"What is the capital of France?"ï¼‰
    
    Returns:
        None
    """
```

**å‚æ•°è¯´æ˜**

| å‚æ•°å | ç±»å‹ | æè¿° | å¿…éœ€ |
|--------|------|------|------|
| `db` | å‘é‡æ•°æ®åº“ | å·²åˆå§‹åŒ–çš„å‘é‡æ•°æ®åº“å®ä¾‹ | æ˜¯ |
| `qa` | é—®ç­”é“¾ | LangChainé—®ç­”ç³»ç»Ÿé“¾ | æ˜¯ |
| `test_question` | str | ç”¨äºæµ‹è¯•çš„é—®é¢˜æ–‡æœ¬ | å¦ |

### 3. éªŒè¯æµç¨‹è®¾è®¡

#### å¤„ç†æ­¥éª¤è¯¦è§£

**æ­¥éª¤1ï¼šç³»ç»Ÿæ ‡è¯†**
```
======= RAG å‘é‡æ£€ç´¢éªŒè¯ =======
ã€æµ‹è¯•é—®é¢˜ã€‘ï¼š[ç”¨æˆ·è¾“å…¥çš„æµ‹è¯•é—®é¢˜]
```

**æ­¥éª¤2ï¼šå‘é‡æ£€ç´¢**
- **æ£€ç´¢å‚æ•°**: `k=3`ï¼ˆè·å–å‰3ä¸ªæœ€ç›¸å…³æ–‡æ¡£ï¼‰
- **æ£€ç´¢æ–¹æ³•**: åŸºäºå‘é‡ç›¸ä¼¼åº¦æœç´¢
- **ç»“æœéªŒè¯**: æ£€æŸ¥æ˜¯å¦æˆåŠŸæ£€ç´¢åˆ°æ–‡æ¡£

**æ­¥éª¤3ï¼šç»“æœå±•ç¤º**
- **æ–‡æ¡£åˆ—è¡¨**: æŒ‰ç›¸å…³æ€§æ’åºæ˜¾ç¤ºå‰3ä¸ªæ–‡æ¡£
- **æ ¼å¼è¾“å‡º**: æ¯ä¸ªæ–‡æ¡£å¸¦åºå·å’Œå®Œæ•´å†…å®¹
- **ç©ºç»“æœå¤„ç†**: æä¾›æ˜ç¡®çš„é”™è¯¯æç¤ºå’Œå»ºè®®

**æ­¥éª¤4ï¼šé—®ç­”æµ‹è¯•**
- **è¾“å…¥æ„å»º**: ç»„åˆç”¨æˆ·é—®é¢˜å’Œæ£€ç´¢æ–‡æ¡£
- **å¼‚å¸¸å¤„ç†**: æ•è·å¹¶æŠ¥å‘ŠLLMè°ƒç”¨é”™è¯¯
- **ç»“æœå±•ç¤º**: æ˜¾ç¤ºæœ€ç»ˆç”Ÿæˆçš„ç­”æ¡ˆ

#### è¯¦ç»†å·¥ä½œæµç¨‹

```
å¼€å§‹éªŒè¯ â†’ æ‰“å°ç³»ç»Ÿæ ‡è¯† â†’ æ‰§è¡Œå‘é‡æ£€ç´¢ â†’ 
æ£€æŸ¥ç»“æœ â†’ å±•ç¤ºæ£€ç´¢æ–‡æ¡£ â†’ è°ƒç”¨é—®ç­”ç³»ç»Ÿ â†’ 
æ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ â†’ å¼‚å¸¸å¤„ç† â†’ ç»“æŸéªŒè¯
```

### 4. åŠŸèƒ½ç‰¹æ€§

#### 4.1 æ£€ç´¢éªŒè¯

**æ£€ç´¢é…ç½®**
```python
retriever = db.as_retriever(search_kwargs={"k": 3})
docs = retriever.get_relevant_documents(test_question)
```

**æ£€ç´¢ç»“æœåˆ†æ**
- **æˆåŠŸåœºæ™¯**: æ˜¾ç¤º3ä¸ªæœ€ç›¸å…³æ–‡æ¡£
- **å¤±è´¥åœºæ™¯**: æç¤ºæ£€æŸ¥æ•°æ®åº“æ„å»º
- **æ€§èƒ½æŒ‡æ ‡**: éšå«çš„æ£€ç´¢æ—¶é—´æµ‹é‡

#### 4.2 é—®ç­”é“¾è·¯æµ‹è¯•

**è¾“å…¥æ ¼å¼**
```python
result = qa.invoke({
    "query": test_question,
    "documents": docs
})
```

**è¾“å‡ºå¤„ç†**
- **ä¼˜å…ˆå­—æ®µ**: `result.get("result", result)`
- **å®¹é”™æœºåˆ¶**: æ”¯æŒå¤šç§è¿”å›æ ¼å¼
- **å¼‚å¸¸æ•è·**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º

### 5. ä½¿ç”¨ç¤ºä¾‹

#### åŸºç¡€ä½¿ç”¨

```python
from retriever_test import test_vector_retrieval_and_answer
from langchain.vectorstores import Chroma
from langchain_openai import ChatOpenAI
from langchain.chains import RetrievalQA

# åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶
embeddings = OpenAIEmbeddings()
db = Chroma(persist_directory="./chroma_db", embedding_function=embeddings)
llm = ChatOpenAI(model_name="deepseek-chat")
qa = RetrievalQA.from_chain_type(llm=llm, retriever=db.as_retriever())

# è¿è¡ŒéªŒè¯æµ‹è¯•
test_vector_retrieval_and_answer(db, qa)
```

#### è‡ªå®šä¹‰æµ‹è¯•

```python
# ä½¿ç”¨è‡ªå®šä¹‰æµ‹è¯•é—®é¢˜
test_vector_retrieval_and_answer(
    db=vector_store,
    qa=qa_chain,
    test_question="ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ä¸­çš„è¿‡æ‹Ÿåˆï¼Ÿ"
)

# æ‰¹é‡æµ‹è¯•å¤šä¸ªé—®é¢˜
test_questions = [
    "Pythonçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ",
    "å¦‚ä½•é˜²æ­¢è¿‡æ‹Ÿåˆï¼Ÿ",
    "ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿ"
]

for question in test_questions:
    test_vector_retrieval_and_answer(db, qa, question)
    print("\n" + "="*50 + "\n")
```

#### é›†æˆæµ‹è¯•è„šæœ¬

```python
# å®Œæ•´æµ‹è¯•è„šæœ¬
import os
from retriever_test import test_vector_retrieval_and_answer

def run_comprehensive_test():
    """è¿è¡Œå®Œæ•´çš„RAGç³»ç»Ÿæµ‹è¯•"""
    
    # æ£€æŸ¥ç¯å¢ƒ
    if not os.getenv("OPENAI_API_KEY"):
        print("âŒ é”™è¯¯ï¼šæœªè®¾ç½®OPENAI_API_KEYç¯å¢ƒå˜é‡")
        return
    
    try:
        # åˆå§‹åŒ–ç»„ä»¶ï¼ˆå‡è®¾å·²å®šä¹‰ï¼‰
        from qa_system import create_qa_chain
        from data_processing import load_and_clean_data
        
        # åŠ è½½æ•°æ®
        qa_texts, _ = load_and_clean_data()
        
        # åˆ›å»ºæ•°æ®åº“å’Œé—®ç­”é“¾
        db = create_vector_db(qa_texts)  # ç”¨æˆ·å®ç°çš„å‡½æ•°
        qa = create_qa_chain(db)
        
        # è¿è¡ŒéªŒè¯
        test_vector_retrieval_and_answer(db, qa)
        
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥ï¼š{e}")

if __name__ == "__main__":
    run_comprehensive_test()
```

### 6. è°ƒè¯•æŒ‡å—

#### 6.1 å¸¸è§é—®é¢˜è¯Šæ–­

**é—®é¢˜1ï¼šæœªæ£€ç´¢åˆ°æ–‡æ¡£**
```
ç—‡çŠ¶ï¼šæ˜¾ç¤º"æœªæ£€ç´¢åˆ°ä»»ä½•ç›¸å…³æ–‡æ¡£"
åŸå› ï¼š
- å‘é‡æ•°æ®åº“ä¸ºç©º
- æ•°æ®åº“æ„å»ºå¤±è´¥
- æµ‹è¯•é—®é¢˜ä¸æ•°æ®é›†ä¸åŒ¹é…
è§£å†³ï¼š
- æ£€æŸ¥æ•°æ®åº“æ„å»ºæ—¥å¿—
- éªŒè¯æ•°æ®å·²æ­£ç¡®å‘é‡åŒ–
- ä½¿ç”¨æ›´é€šç”¨çš„é—®é¢˜æµ‹è¯•
```

**é—®é¢˜2ï¼šLLMè°ƒç”¨å¤±è´¥**
```
ç—‡çŠ¶ï¼šæ˜¾ç¤º"è°ƒç”¨ LLM å¤±è´¥" + é”™è¯¯ä¿¡æ¯
åŸå› ï¼š
- APIå¯†é’¥æ— æ•ˆ
- ç½‘ç»œè¿æ¥é—®é¢˜
- æ¨¡å‹æœåŠ¡ä¸å¯ç”¨
è§£å†³ï¼š
- éªŒè¯APIå¯†é’¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤æ¨¡å‹æœåŠ¡çŠ¶æ€
```

**é—®é¢˜3ï¼šè¿”å›æ ¼å¼å¼‚å¸¸**
```
ç—‡çŠ¶ï¼šè¾“å‡ºæ ¼å¼ä¸ç¬¦åˆé¢„æœŸ
åŸå› ï¼š
- LangChainç‰ˆæœ¬ä¸å…¼å®¹
- è¿”å›æ•°æ®ç»“æ„å˜åŒ–
è§£å†³ï¼š
- å‡çº§/é™çº§LangChainç‰ˆæœ¬
- æ£€æŸ¥resultæ•°æ®ç»“æ„
```

#### 6.2 éªŒè¯ç­–ç•¥

**åˆ†å±‚éªŒè¯**
1. **æ•°æ®åº“éªŒè¯**: ç¡®è®¤å‘é‡æ•°æ®åº“æ­£å¸¸å·¥ä½œ
2. **æ£€ç´¢éªŒè¯**: éªŒè¯æ£€ç´¢å™¨è¿”å›é¢„æœŸç»“æœ
3. **é—®ç­”éªŒè¯**: æµ‹è¯•å®Œæ•´é—®ç­”é“¾è·¯
4. **æ€§èƒ½éªŒè¯**: æµ‹é‡å“åº”æ—¶é—´

**æµ‹è¯•æ•°æ®é›†**
```python
# æ ‡å‡†æµ‹è¯•é—®é¢˜é›†
STANDARD_TESTS = {
    "çŸ¥è¯†å­˜åœ¨": "What is machine learning?",
    "çŸ¥è¯†ä¸å­˜åœ¨": "What is the meaning of life?",
    "æ¨¡ç³ŠæŸ¥è¯¢": "AI technology",
    "ç²¾ç¡®æŸ¥è¯¢": "Supervised learning definition"
}
```

### 7. æ€§èƒ½ç›‘æ§

#### 7.1 æŒ‡æ ‡æ”¶é›†

**åŸºç¡€æŒ‡æ ‡**
- æ£€ç´¢å»¶è¿Ÿï¼šå‘é‡æœç´¢æ—¶é—´
- ç”Ÿæˆå»¶è¿Ÿï¼šLLMå“åº”æ—¶é—´
- æ€»å¤„ç†æ—¶é—´ï¼šç«¯åˆ°ç«¯å»¶è¿Ÿ

**è´¨é‡æŒ‡æ ‡**
- æ£€ç´¢å‘½ä¸­ç‡ï¼šè¿”å›æ–‡æ¡£æ•°é‡
- æ–‡æ¡£ç›¸å…³æ€§ï¼štop-kæ–‡æ¡£è´¨é‡
- å›ç­”å‡†ç¡®ç‡ï¼šç­”æ¡ˆæ­£ç¡®æ€§

#### 7.2 æ€§èƒ½æµ‹è¯•

```python
import time

def performance_test(db, qa, test_question):
    """æ€§èƒ½æµ‹è¯•å‡½æ•°"""
    
    # æµ‹è¯•æ£€ç´¢æ€§èƒ½
    start = time.time()
    retriever = db.as_retriever(search_kwargs={"k": 3})
    docs = retriever.get_relevant_documents(test_question)
    retrieval_time = time.time() - start
    
    # æµ‹è¯•é—®ç­”æ€§èƒ½
    start = time.time()
    result = qa.invoke({"query": test_question, "documents": docs})
    qa_time = time.time() - start
    
    # æ‰“å°æ€§èƒ½æŠ¥å‘Š
    print(f"ğŸ” æ£€ç´¢æ—¶é—´: {retrieval_time:.3f}ç§’")
    print(f"ğŸ¤– é—®ç­”æ—¶é—´: {qa_time:.3f}ç§’")
    print(f"âš¡ æ€»è€—æ—¶: {retrieval_time + qa_time:.3f}ç§’")
    print(f"ğŸ“Š æ£€ç´¢æ–‡æ¡£æ•°: {len(docs)}")
```

### 8. æ‰©å±•åŠŸèƒ½

#### 8.1 å¢å¼ºéªŒè¯

**å¤šæ ·æ€§æµ‹è¯•**
```python
def test_diversity(db, qa, questions):
    """æµ‹è¯•å¤šä¸ªä¸åŒç±»å‹çš„é—®é¢˜"""
    for q in questions:
        print(f"\nğŸ§ª æµ‹è¯•é—®é¢˜: {q}")
        test_vector_retrieval_and_answer(db, qa, q)
```

**è¾¹ç•Œæµ‹è¯•**
```python
BOUNDARY_TESTS = [
    "",  # ç©ºé—®é¢˜
    "a",  # å•å­—ç¬¦
    "x" * 1000,  # è¶…é•¿é—®é¢˜
    "ä¸­æ–‡æµ‹è¯•é—®é¢˜",  # éè‹±æ–‡
]
```

#### 8.2 ç»“æœåˆ†æ

**æ£€ç´¢ç»“æœåˆ†æ**
```python
def analyze_retrieval_results(docs):
    """åˆ†ææ£€ç´¢ç»“æœè´¨é‡"""
    if not docs:
        return
    
    print("ğŸ“ˆ æ£€ç´¢ç»“æœåˆ†æ:")
    for i, doc in enumerate(docs, 1):
        length = len(doc.page_content)
        print(f"  æ–‡æ¡£{i}: {length}å­—ç¬¦")
        if hasattr(doc, 'metadata'):
            print(f"    å…ƒæ•°æ®: {doc.metadata}")
```

### 9. éƒ¨ç½²å»ºè®®

#### 9.1 æµ‹è¯•ç¯å¢ƒ

**æœ€å°é…ç½®**
- æµ‹è¯•æ•°æ®é›†ï¼š100-1000æ¡è®°å½•
- å‘é‡ç»´åº¦ï¼š1536ï¼ˆOpenAI embeddingsï¼‰
- æ£€ç´¢kå€¼ï¼š3-5

**éªŒè¯æµç¨‹**
1. æ•°æ®å‡†å¤‡ï¼šç¡®ä¿æµ‹è¯•æ•°æ®å·²åŠ è½½
2. ç³»ç»Ÿå¯åŠ¨ï¼šåˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
3. åŠŸèƒ½éªŒè¯ï¼šè¿è¡Œæ ‡å‡†æµ‹è¯•
4. æ€§èƒ½æ£€æŸ¥ï¼šæµ‹é‡å“åº”æ—¶é—´

#### 9.2 ç”Ÿäº§ç›‘æ§

**å¥åº·æ£€æŸ¥**
```python
def health_check(db, qa):
    """ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    try:
        test_vector_retrieval_and_answer(db, qa)
        return {"status": "healthy", "message": "ç³»ç»Ÿè¿è¡Œæ­£å¸¸"}
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}
```

## æ€»ç»“

æœ¬æ£€ç´¢éªŒè¯ç³»ç»Ÿä¸ºRAGåº”ç”¨æä¾›äº†è½»é‡çº§ä½†åŠŸèƒ½å®Œæ•´çš„æµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æ ‡å‡†åŒ–çš„éªŒè¯æµç¨‹å’Œè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œå¼€å‘è€…å¯ä»¥å¿«é€ŸéªŒè¯ç³»ç»Ÿæ­£ç¡®æ€§ã€è¯Šæ–­é—®é¢˜å¹¶ä¼˜åŒ–æ€§èƒ½ã€‚ç³»ç»Ÿè®¾è®¡æ³¨é‡å®ç”¨æ€§å’Œæ˜“ç”¨æ€§ï¼Œé€‚ç”¨äºå¼€å‘æµ‹è¯•ã€è´¨é‡ä¿è¯å’Œç”Ÿäº§ç›‘æ§ç­‰å¤šç§åœºæ™¯ã€‚

è¯¥ç³»ç»Ÿè™½ç„¶ä»£ç ç®€æ´ï¼Œä½†è¦†ç›–äº†RAGç³»ç»Ÿçš„å…³é”®éªŒè¯ç‚¹ï¼Œæ˜¯ç¡®ä¿ç³»ç»Ÿå¯é æ€§çš„é‡è¦å·¥å…·ã€‚